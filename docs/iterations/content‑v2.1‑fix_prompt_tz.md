# AXIOM — ТЗ‑ЦИКЛ ДЛЯ АГЕНТА `content‑v2.1‑fix`

> Этот файл — **операционный сценарий (SOP)** для ежедневной работы агента по итерации `content‑v2.1‑fix`.
> **Единственный источник правды по задачам, требованиям и AC** — документ: `docs/iterations/content‑v2.1‑fix.md`.
> В нём: §12 (Roadmap/чек‑лист) и §13 (CHANGELOG/LOG). Читай его **целиком** перед началом и сверяйся каждый раз перед коммитом.

---

## 0) Водные и правила

* Рабочий файл итерации: **`docs/iterations/content‑v2.1‑fix.md`**.

  * Галочки ставим **только** в §12.
  * Живой журнал ведём **только** в §13, внутри блока **`LOG:START/LOG:END`**; новые записи — **сверху** (reverse‑chronological).
* Формат CHG‑ID: `CHG-YYYY-MM-DD-XXX` (сквозная нумерация в пределах дня).
* Timezone: **Europe/Berlin**. Формат времени: `YYYY-MM-DD HH:mm`.
* Сообщения коммитов — **Conventional Commits** (+ ссылка на CHG и пункт §12).
* Ограничения изменения файла итерации:

  * НЕЛЬЗЯ менять заголовки разделов и маркеры `LOG:START/LOG:END`.
  * Разрешено добавлять записи CHG и ставить галочки; при необходимости — дополнять примечания в §13.
* Безопасность и стиль кода — см. требования в самом ТЗ (§4, §7, §8): DOMPurify, sandbox, отсутствие протечек CSS, a11y ≥ 90, perf‑бюджеты.

---

## 1) Подготовка окружения (разовая)

* [ ] Клонировать репозиторий и перейти на ветку `feature/content‑v2.1‑fix`.
* [ ] Установить зависимости (Node 18+/20+, pnpm/npm — согласно проекту).
* [ ] Запустить DEV: `npm run dev` (или команда проекта). Убедиться, что `/dashboard/content` открывается.
* [ ] Снять базовые метрики Lighthouse/axe (для сравнения после изменений).
* [ ] Прочитать `docs/iterations/content‑v2.1‑fix.md` полностью: контекст, требования §4, план §5, чек‑лист §12, правила журнала §13.

---

## 2) Цикл работы по каждой задаче из §12 (итеративный)

**Цель:** каждый пункт §12 проходит через одинаковые ворота качества и оставляет артефакты.

1. **Выбор пункта**

   * Открой §12 и выбери следующий пункт по приоритету (P0 → P1 → P2).
   * Если пункт большой — разбей на под‑подзадачи (подпункты в записи CHG).

2. **Заведи черновик записи в §13 (статус OPEN)**

   * Вставь блок:

     * Заголовок `#### CHG‑YYYY‑MM‑DD‑XXX — [TYPE] … (OPEN)`
     * `Related:` ссылки на пункты §12 (например, `§12.3‑P0`).
     * `Artifacts:` пока пусто или «branch TBD».
     * `Changes:` перечисли план шагов (буллеты).
     * `AC Check:` перечисли AC из §12 для этой задачи (пока без галочек).

3. **Создай ветку**

   * Именование: `feat/content‑v2.1‑fix/<кратко>` или `fix/content‑v2.1‑fix/<кратко>`.

4. **Реализация**

   * Следуй требованиям из §4 (renderMode, prefixStyles, resolveAssets, PreviewPane/Bar, sandbox и т.д.).
   * При работе с гибридом: никаких `<script>`; поведение через хуки и `data-*`.
   * Для ассетов используй `assetsBase`; проверь относительные `src|href`.

5. **Локальная проверка**

   * Юнит/интеграция (при наличии), ручные сценарии из §6 (таблица тестов).
   * a11y (axe/Lighthouse ≥ 90), perf (TTI прирост в норме), кросс‑браузерно.

6. **Обнови §13 (IN_PROGRESS → DONE/PARTIAL)**

   * Заполни `Artifacts:` (коммиты, PR, пути файлов).
   * В `Changes:` перечисли фактически сделанные изменения.
   * В `AC Check:` отметь выполненные пункты `- [x] …`.
   * Если есть хвосты — `Result: PARTIAL` и заведи следующий CHG для остатка.

7. **Обнови §12 (галочки)**

   * Отметь чек‑пункты `- [x]` и допиши хвост `✅ (YYYY‑MM‑DD, by <имя>, CHG‑ID)`.

8. **PR и ревью**

   * Оформи PR по шаблону (описание «why/what/ac/refs»; метки `content‑v2.1‑fix`, `feat|fix|…`).
   * Ревьюер проверяет соответствие AC и стайлгайда.

9. **Мерж и смоук‑тест**

   * После merge — smoke DEV/Preview, если нужно — откат `[REVERT]` через новый CHG.

10. **Дайджест дня (опционально)**

    * В конце дня добавь `DIGEST` в §13 (что закрыто/открыто/риски/планы).

---

## 3) Опорные материалы (откуда брать детали)

* **Главный документ:** `docs/iterations/content‑v2.1‑fix.md`.

  * §4 — требования к рендеру/безопасности/UX.
  * §5 — пошаговый план.
  * §6 — тестовый план.
  * §12 — Roadmap/чек‑лист для галочек.
  * §13 — CHANGELOG/LOG для живых записей (только между `LOG:START/LOG:END`).
* Примеры CHG и шаблоны коммитов — см. §13.5–13.8 этого же файла.

---

## 4) Критерии «Готово» (Definition of Done)

* Завершённые пункты §12 отмечены `[x]` + пометка `✅ (дата, имя, CHG‑ID)`.
* В §13 есть запись CHG со статусом **DONE** (или серия, где последний закрывает все AC).
* Пройдены проверки: функциональные сценарии §6, a11y ≥ 90, ошибки консоли отсутствуют, ассеты грузятся.
* Для гибридов: нет протечки CSS; изображения/ссылки резолвятся; скриптов в контенте нет; поведение через хуки работает.
* PR принят и смёржен; для релевантных — есть краткий пост‑мердж smoke.

---

## 5) Быстрый старт (рекомендуемая первая тройка задач)

1. **§12.2‑P0 Схема и VFS** — поля `renderMode`, `assetsBase`, `lang`, `version`, `links`; strict‑валидация Ajv.
2. **§12.3‑P0 PrefixStyles/resolveAssets** — префиксация CSS и резолвер ссылок.
3. **§12.5‑P0 PreviewPane/PreviewBar + sandbox** — новый рендер и тулбар.

После этого — миграция `CHR‑VIKTOR‑0301` и `CHR‑AXIOM‑0303` (§12.9‑P0), затем UI‑редизайн (§12.7‑P1) и токены (§12.8‑P1).

---

## 6) Шаблоны (скопируй при работе)

**Заготовка CHG в §13:**

```md
#### CHG-YYYY-MM-DD-XXX — [TYPE] Короткий заголовок (OPEN)
**Related:** §12.x-Px
**Artifacts:** branch …
**Changes (plan):**
- шаг 1…
- шаг 2…
**AC Check:**
- [ ] AC‑1 …
- [ ] AC‑2 …
**Result:** OPEN
```

**Коммит (Conventional):**

```
feat(content): кратко — что сделано по пунктам §12.x‑Px

why:
- мотивация/контекст

what:
- основные изменения по файлам

ac:
- ссылка на AC из §12

refs:
- CHG-YYYY-MM-DD-XXX, §12.x-Px
```

**PR (шаблон описания):**

* Почему (problem/goal)
* Что сделано (bullets)
* Как проверять (сценарии/команды)
* AC‑чек (галочки)
* Риски/ограничения
* Refs: CHG, §12

---

## 7) Эскалация и блокеры

* Если задача блокируется внешней зависимостью — пометь запись `BLOCKED` в §13, опиши причину и предполагаемое решение/владелец.
* Если найден критичный регресс/уязвимость — немедленно заведи `[FIX]`/`[REVERT]` CHG и сообщи ревьюеру.

---

## 8) Контроль качества (быстрый чек перед PR)

* [ ] Нет ошибок в консоли при навигации по `/dashboard/content`.
* [ ] В гибридном превью стили не протекают наружу (меню/тикер неизменны).
* [ ] Изображения/ссылки в гибридах работают (нет 404).
* [ ] Переключение `plain/hybrid/sandbox` работает без перезагрузки.
* [ ] Zoom 100/125/150 корректно масштабирует только превью.
* [ ] Axe/Lighthouse ≥ 90, `prefers-reduced-motion` учитывается.
* [ ] Кросс‑браузерно (Chrome/Firefox/Safari) — минимум smoke.

---

**Работай строго по этому циклу. Все детали — в `docs/iterations/content‑v2.1‑fix.md`.**
