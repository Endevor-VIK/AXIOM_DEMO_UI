<!--
PATCH: docs/iterations/content‑v2.1‑fix.md
-->
# AXIOM Codex Agent — Развернутое техническое задание на итерацию `content‑v2.1‑fix`

<!--
Этот документ является расширенной версией предыдущего ТЗ.  Он объединяет результаты
исследования репозитория `AXIOM_DEMO_UI` (ветка `feature/content-v2.1-fix`),
наблюдения со скриншотов и дополнительные рекомендации.  Документ упорядочен по
темам: общий контекст, анализ текущего состояния, требования к новой итерации,
пошаговый план, тестовый план, дополнительные улучшения и рекомендации для
смежных модулей.  Старайтесь использовать этот файл как единую точку истинны
при планировании работ.
-->

## 1. Контекст и цели

### 1.1 Предпосылки
Проект **AXIOM_DEMO_UI** представляет собой интерактивную витрину контента, построенную на Remix + React.  На этапе v2.0 поддерживались только статические HTML‑файлы и чистые markdown‑файлы, которые отображались в карточках раздела «Content».  С появлением ветки `feature/content‑v2.1‑fix` команда начала экспериментировать с «гибридными» файлами — документами, сочетающими стандартный markdown и полноценные HTML‑обёртки со встроенными стилями и скриптами.  Примеры таких материалов: `CHR‑VIKTOR‑0301` и `CHR‑AXIOM‑0303`.

Гибридные файлы обнаружили ряд архитектурных слабых мест:

- Стили из `<style>` не изолированы и модифицируют глобальные элементы (меню, навигацию, новости).
- Скрипты удаляются санитайзером, что ломает поведение (IntersectionObserver, параллакс, tilt).
- Изображения с относительными путями не загружаются.
- Отсутствует возможность выбирать способ отображения (md vs sandbox).

Одновременно стало очевидно, что элементы оформления из этих гибридных файлов (тонкие анимации, подчёркивания, красная палитра) отлично подходят для общей стилистики проекта.  Нужно перенести эти находки в глобальный дизайн.

### 1.2 Бизнес‑цели

1. **Построить гибкую и безопасную систему отображения контента**, где авторы смогут использовать сложные обложки и интерактивные элементы, а UI‑слой останется единообразным и предсказуемым.
2. **Обновить дизайн хаба контента** в духе Red Protocol: компактные элементы, единая панель превью, бегущий ticker, информативный status‑bar и категории‑плитки.
3. **Поддержать расширяемость**: закладываем архитектуру на будущее, где могут появиться 3D‑демо, игры или обучающие модели, требующие iframe/sandbox.
4. **Повысить доступность**: обеспечить работу с клавиатуры, корректные цвета и учёт пользовательских предпочтений (`prefers-reduced-motion`).
5. **Улучшить качество данных**: расширить schema manifest, обеспечить строгую валидацию и возможность локализации контента.

### 1.3 Определения и терминология
- **Гибридный файл** — markdown‑документ, содержащий HTML‑блоки, `<style>` и потенциально `<script>`.  Контент разделён на «cover» (обложка с визуальным оформлением и описанием) и «core» (содержательная часть в markdown).
- **renderMode** — режим отрисовки записи: `plain`, `hybrid`, `sandbox` (см. §4).
- **assetsBase** — базовый путь для разрешения относительных ссылок на изображения, аудио, видео и другие файлы в контенте.
- **PreviewPane** — унифицированная панель для отображения выбранного материала с тулбаром, zoom, переключателями и iframe (если требуется).

## 2. Обзор текущей системы

### 2.1 Архитектура приложения

- **Remix Root (`app/`)**:  Разделён на маршруты (`routes`) и лэйауты (`_layout.tsx`).  Основные маршруты:
  - `/dashboard` — главная панель; отображает контролы статуса и список последних обновлений.
  - `/dashboard/content` — хаб контента; загружает список контент‑элементов, фильтрует их и показывает превью выбранной записи.
  - `/dashboard/roadmap` и `/dashboard/audit` — отдельные источники контента (html), тоже использующие `PreviewPane`.
  - `/dashboard/news` — лента новостей с ticker‑ом.
- **Состояние контента** хранится в контексте (`app/routes/dashboard/content/context.tsx`): фильтры (query, tag, status, lang, view), массив pinned‑id, текущее значение `dataBase` для VFS.
- **Navigation**: верхнее меню (`Home`, `Roadmap`, `Audit`, `Content`, `News`) реализовано в `_layout.tsx`, статус‑строка (`ENV :: DEV | ONLINE | Время`) — в `components/StatusLine.tsx`.

### 2.2 Данные и virtual file system

- **VFS (`lib/vfs/`)** — обёртка над `fetch`, обеспечивающая:
  - Защиту от выходов за пределы `public/data` (path traversal), добавляя префикс `data/` и проверяя `../`.
  - Кэширование ответов в `Map` и поддержку параметра `force` для bypass.
  - Чтение JSON и текстов (`json`, `text`), сборку агрегата контента (`readContentAggregate`) и лора (`readLoreIndex`), и чтение новостей (`readNewsManifest`).
  - Проверку схемы манифеста (`_schema/content.schema.json`) через Ajv.

- **Манифест (`public/data/content/manifest.json`)** хранит список записей.  Каждая запись — объект с полями: `id`, `category`, `title`, `file`, `format`, `date`, `status`, `tags`, `lang`, `author`, `weight`, `visibility`, `meta`.  В текущей версии нет полей `renderMode` и `assetsBase`.
- **Лор (`public/data/content/lore/`)** — древовидная структура для навигации по главам и сценам (не используется в v2.0 UI, но встроена в VFS).

### 2.3 UI‑компоненты

- **Content hub**:
  - `ContentCategoryTiles.tsx` — генерирует плитки для категорий.  Плитка — это `<button>` с иконкой, заголовком и счётчиком, с поддержкой клавиатурной навигации (Arrow keys, Home/End).
  - `ContentFilters.tsx` — набор `<input type="search">` и `<select>` для query/tag/status/lang и две кнопки для переключения вида (cards/list).  Значения фильтров сохраняются в контекст и URL, что позволяет делиться ссылкой.
  - `ContentList.tsx` — отображает список карточек (в виде `cards` или `list`).  Карточка содержит заголовок, дату, summary и список тегов.  По клику устанавливает текущий выбранный элемент (через search param `item`).
  - `PreviewPane.tsx` — рендерит выбранный файл: md — через `marked` + `DOMPurify`, html — через `<iframe>`, txt — через `<pre>`.  Умеет выводить заголовок/дата/чипы и ссылку на исходник.

- **Другие общие компоненты**:
  - `Ticker.tsx` — бесконечный бегущий ряд новостей с дублями списка (для бесшовности), учитывает `prefers-reduced-motion`.
  - `StatusLine.tsx` — нижняя строка с ENV/Online/Time/Route и возможностью выводить «Mode // Section».
  - `PreviewBar` отсутствует как отдельный компонент, поэтому тулбары в разных разделах реализованы по‑разному.

### 2.4 Дизайн и токены

- **Токены (`ax-design/tokens.css`)** определяют цветовую палитру (красно‑чёрная), размеры шрифтов и скруглений, коэффициенты расстояний, шрифтовые семейства.  В текущей версии базовая плотность (`--ax-scale`) равна 1.0.  Для итерации требуется уменьшить её до 0.9 для большей компактности.
- **Компоненты (`ax-design/components.css`)** — набор атомарных классов: `.ax-btn`, `.ax-input`, `.ax-chip`, `.ax-card`, `.ax-tab` и т. д.  Также содержит стили для модальных окон, ticker’а, статус‑баров и лейаутов.
- **styles/app.css** — прикладные стили, задающие общий каркас (topbar, main, status bar), сетку, размеры шрифтов по умолчанию, эффекты фокуса, и множество utility‑классов.  Содержит имплементацию режима Red Protocol (градиенты, тени, бордюры).

## 3. Выявленные проблемы и ограничения

1. **Протечка CSS из гибридных файлов.**  Текущий парсер Markdown (`marked`) не изолирует стили из `<style>` — правила применяются глобально.  Это проявляется тем, что hover‑эффекты и underline из файла Виктора появляются в основном меню и ticker’е.  Аналогично, глобальные переменные (например, `--ax-bg`) могут быть переопределены.
2. **Скрипты не исполняются.**  DOMPurify удаляет `<script>`, поэтому все JS‑эффекты (reveal, tilt, lazy‑loading, кастомные аудио‑плееры) не работают.  При этом попытки оставить `<script>` внутри MD являются небезопасными и запрещены.
3. **Не резолвятся относительные пути.**  Относительные `src` и `href` остаются неизменными; браузер ищет их относительно текущего URL (`/dashboard/content/…`) и не находит.  Загрузка изображений, аудио и PDF в гибридных файлах невозможна без переписывания ссылок.
4. **Нет выбора режима рендера.**  `PreviewPane` принимает решение на основе поля `format`.  Гибридный файл с форматом `md` всегда интерпретируется как markdown, а `html` — всегда как iframe.  Нет возможности рендерить гибрид в iframe или использовать sandbox для запуска скриптов.
5. **UX‑несогласованность.**  Разные разделы (`roadmap`, `audit`, `content`) отображают превью по‑разному.  В roadmap — панель с вкладками и scaling, в audit — список слева, превью справа, в content — sticky‑preview справа.  Для пользователя это несогласованный опыт.
6. **Отсутствие локализации и версионирования.**  Записи не имеют поля `lang` для будущего мультиязычного контента.  Нет механизма связывать несколько языковых вариантов одной записи или указывать версию файла (v2.1 vs v3).  Некоторые поля (`meta.v`) используются, но не документированы.
7. **Слабая валидация манифеста.**  Schema проверяет только присутствие полей, но не проверяет форматы (`date` должен быть ISO8601), диапазоны (`weight` >= 0), уникальность `id`, корректность `category`, или наличие файла на диске.  Это повышает риск битых записей.

## 4. Требования к новой итерации

### 4.1 Обогащение схемы данных

1. **Добавить новые поля в `ContentItem`**:
   - `renderMode: 'plain' | 'hybrid' | 'sandbox'` — режим отображения.
   - `assetsBase?: string` — базовый путь для разрешения относительных ссылок.
   - `version?: string` — версия файла (например, `v2.1.0`) для отслеживания изменений и обратной совместимости.
   - `lang?: string` — код языка ISO 639-1 (например, `ru`, `en`).  Наличие нескольких записей с разными языками и одинаковым `id` допускается; связь определяется по полю `links`.
   - `links?: ContentLink[]` — список связанных материалов (например, английская версия, родительская глава лора, связанный персонаж).

2. **Документировать поля `meta`**: определить структуру, например:
   ```json
   {
     "v": 2,
     "cover": {
       "title": "string",
       "description": "string",
       "image": "string"
     },
     "stats": {
       "views": "number",
       "favorites": "number"
     }
   }
    ```

3. **Расширить JSON‑схему** (`public/data/content/_schema/content.schema.json`) так, чтобы валидировать новые поля, форматы дат, диапазоны `weight`, присутствие `file` в файловой системе и т. д.
4. **Обновить VFS**: методы `readContentManifest()` и `readContentAggregate()` должны игнорировать или помечать записи, которые не проходят валидацию.  Добавить параметр `strict` для остановки загрузки при ошибке (для dev‑режима).

### 4.2 Режимы рендера

#### plain

* Markdown парсится и очищается (`marked` + `DOMPurify`).  Извлекаются только безопасные теги (p, h1-h6, ul, ol, li, strong, em, img, a, table).  `<style>` и `<script>` удаляются.
* Классы и id из HTML игнорируются, чтобы избежать конфликтов.
* Разрешён инлайн‑HTML для простых элементов (например, `<span style="color:red">`), но такие стили переносятся в атрибут `style` только после проверки на недопустимые свойства (no position:fixed, no z-index, no pointer-events).

#### hybrid

* После парсинга markdown ищется первый `<style>`-блок (или несколько) и передаётся в префиксер.  В случае нескольких блоков они объединяются.
* Префиксер должен поддерживать:

  * Простые селекторы (элементы, классы, id) и комбинированные (`.class:hover`, `.parent .child`, `.parent > .child`).
  * Медиа‑запросы (`@media`), ключевые кадры (`@keyframes`), пользовательские свойства (`:root {}`) — в таких случаях префикс добавляется после имени правила или переименовывается (`@keyframes myAnim` → `@keyframes ax-ID-myAnim`).
  * Псевдоэлементы `::before`, `::after`, `::backdrop` и пр.
* Вставить префиксованный CSS в `<style data-ax-scope="{id}"></style>` в начало сформированного HTML.
* Обернуть всё содержимое в `<div data-ax-scope="{id}">`.
* Заменить `<script>` на React‑хуки: файл может прописать атрибуты (`data-tilt`, `data-reveal`, `data-audio="sound.mp3"`, `data-video="clip.mp4"`), а `PreviewPane` должен знать, какие хуки активировать.  Список хуков и props нужно документировать для будущих авторов.

#### sandbox

* Загружать HTML файл через `<iframe>` с атрибутами:

  * `srcdoc` — сгенерированный html (если файл формата md) или `src` для готового html.
  * `sandbox="allow-scripts allow-same-origin"` — разрешить выполнение JS и XHR внутри iframe, но запретить доступ к верхнему окну.
  * `allowfullscreen` — в будущем для видео/3D.
* Устанавливать listener `onmessage` для обработки сообщений от iframe (например, изменение высоты по контенту: iframe отправляет `{type: 'resize', height: 1200}`; `PreviewPane` меняет высоту).
* Ограничивать origin: разрешены только relative urls к `public/data/content/`.
* Для безопасности создавать dedicated сервис‑worker, который будет ограничивать доступ iframe к внешним ресурсам (расширение API может обсуждаться в следующей итерации).

### 4.3 Резолвер ассетов

1. В `PreviewPane` или в отдельном хелпере определить функцию:

   ```ts
   function resolveAssets(html: string, assetsBase: string, dataBase: string): string {
     const parser = new DOMParser();
     const doc = parser.parseFromString(html, 'text/html');
     doc.querySelectorAll('[src],[href]').forEach((el) => {
       const attr = el.hasAttribute('src') ? 'src' : 'href';
       const val = el.getAttribute(attr);
       if (val && !/^https?:\/\//.test(val) && !val.startsWith('data:')) {
         el.setAttribute(attr, new URL(val, assetsBase).toString());
       }
     });
     return doc.body.innerHTML;
   }
   ```
2. В случае `renderMode: plain` и `hybrid` вызывать `resolveAssets()` перед вставкой HTML.  В случае `sandbox` оставить относительные пути и пусть iframe сам резолвит (если srcdoc), или предварительно преобразовать через `dataBase`.
3. Поддержать асинхронную загрузку шрифтов, аудио, видео.  Для этого можно в мета `assets` описывать отдельные файлы (`fonts: []`, `audio: []`), а UI загружает их по мере необходимости (например, lazy‑load аудиоплеер).

### 4.4 Расширение `PreviewPane` и `PreviewBar`

1. Разделить логику отображения тулбара и контента:

   * `PreviewBar` принимает `zoom`, `onZoomChange`, `externalHref`, `renderMode`, `onModeChange`, `leadingControls`, `trailingControls`.
   * `PreviewPane` управляет состоянием (zoom, mode, error), передаёт пропсы в `PreviewBar` и рендерит содержимое.

2. API `PreviewPane`:

   ```tsx
   type PreviewPaneProps = {
     item: ContentItem | null;
     dataBase: string;
     initialZoom?: number;
     allowedModes?: Array<'plain' | 'hybrid' | 'sandbox'>;
     onOpenExternal?: (href: string) => void;
   };
   ```

3. Добавить поддержку «reloading»: иногда автор хочет обновить iframe (например, после изменения файла).  В `PreviewBar` можно показывать иконку «↻».

4. Перенести стили превью (границы, фон, тени) в токены и в `components.css`, чтобы переиспользовать в roadmap/audit.

5. Поддержать настройку высоты: в props можно передать `height` или `maxHeight`.

### 4.5 Inline‑expand и full reader

1. Добавить компонент `ContentCardExpanded`, который отрисовывается под карточкой в списке.  Он использует `PreviewPane` и показывает короткий тулбар (без выбора renderMode, так как выбор уже сделан в карточке).  Когда карточка сворачивается, контент размонтируется для освобождения памяти.
2. Создать новый маршрут `/dashboard/content/read.$id.tsx` в Remix:

   ```ts
   export function loader({ params }) {
     return params.id; // далее read на клиенте
   }
   export default function ContentReader() {
     const { id } = useParams();
     const { aggregate, dataBase } = useContentHub();
     const item = aggregate.items.find(it => it.id === id);
     return <PreviewPane item={item} dataBase={dataBase} initialZoom={125} allowedModes={['plain','hybrid','sandbox']} />
   }
   ```
3. Для мобильных экранов использовать full reader по умолчанию: при выборе карточки автоматически перенаправлять на `/read/:id` (т.е. модал перестаёт использоваться).

### 4.6 Редизайн ContentHub

В соответствии с макетом v0.5:

* **Категории**

  * Подготовить массив `CategoryStat[]` с ключами: `key`, `title`, `count`, `to`, `icon`.  Передавать в `ContentCategoryTiles`.
  * Отображать сеткой `repeat(auto-fit, minmax(140px, 1fr))` при ширине < 1000px и 3×2 при шире 1200px.
  * Активная плитка выделяется красной рамкой или glow; использование ARIA: `role="tablist"`, `role="tab"`, `aria-selected`.

* **Фильтры**

  * Использовать компактные классы из `ax-design/components.css` (`ax-input`, `ax-chip`, `ax-btn ghost`).  Перевести высоты на `--input-h`, `--btn-h`.
  * Поиск должен иметь `aria-label`; при вводе query обновлять `filters.query` с debounce (например, 200мс).
  * Для select можно использовать `<select>` или кастомный компонент (`Listbox`) с хорошей поддержкой клавиатуры.

* **Список**

  * В карточке выделять закреплённые элементы (`is-pinned` класс с иконкой закладки).  При клике на значок — вызывать `togglePin(id)` в контексте.
  * Рендерить summary (выдержка) с ограничением по строкам (CSS: `line-clamp: 2`) и всплывающим подсказками при наведении.
  * Добавить аватар автора, если он указан в `meta.author`.  Авторы можно хранить в `public/data/people/` и резолвить аналогично ассетам.

* **Превью**

  * Вниз страницы поместить `PreviewPane` с фиксированной высотой 72vh.  Если выбрана карточка, предварительно прокрутить страницу так, чтобы превью было в зоне видимости.
  * В `PreviewBar` выводить название файла (коротко), режим рендера, zoom.  Справа — кнопка «Open External» и, возможно, кнопка «Expand» для перехода в `read/:id`.

### 4.7 Обновление токенов и UI

1. **RED‑XS density:** уменьшить базовую плотность (`--ax-scale: 0.9`).  Высоты кнопок, чипов, инпутов пересчитать: `--btn-h: calc(40px * var(--ax-scale))`, `--chip-h: calc(28px * var(--ax-scale))`, `--input-h: calc(44px * var(--ax-scale))`.
2. **Глобальные цвета:** определить несколько оттенков красного для разных состояний (primary, danger, warning), оттенки серого для фона и текста, и вспомогательные цвета (gold для release, blue для roadmap и т.д.).  Локализовать их в `:root` и использовать через custom properties.
3. **Underline‑эффекты:** вынести в отдельный класс `.ax-link-underline`.  Реализовать анимацию через `::after` и `transform: scaleX()`; применить в верхнем меню, категориях, метках.
4. **StatusLine:** перенести breadcrumb («MODE :: RED PROTOCOL // SECTION :: CONTENT») вниз; показывать версию (`v0.5.0`), текущий роут (`/dashboard/content`), время (из хука `useTime()`), состояние (`ONLINE/OFFLINE`).  На мобильных часть чипов скрывать.
5. **Topbar:** убрать иконки А+/?!; оставить логотип и меню.  Слева — логотип/название, по центру — меню, справа — переключатель языка (RU/EN) и user avatar (если понадобится).
6. **Ticker:** реализовать бесшовную анимацию через ключевые кадры.  Добавить fade‑маску по краям (`mask-image: linear-gradient(90deg, transparent, black 10%, black 90%, transparent)`).  В случае `prefers-reduced-motion: reduce` — заморозить анимацию и показать список статично.

### 4.8 Версионирование и миграции

1. **Совместимость:** старые записи без `renderMode` следует отображать в режиме `plain`.  При чтении манифеста функция `determineRenderMode(entry)` возвращает значение из поля или `plain`.
2. **Миграция данных:** написать скрипт (например, в `scripts/migrate-v2.1.js`), который:

   * Читает старый `manifest.json`.
   * Добавляет `renderMode` = `plain` для всех записей.
   * Добавляет `assetsBase` = `''`.
   * Копирует файлы гибридных материалов в соответствующие папки (`public/data/content/characters/CHR-VIKTOR-0301/`), обновляет `file` и `assetsBase`.
   * Сохраняет новый манифест в `manifest.v2.1.json` (оставляя старый для бэкапа).
3. **Версионирование API:** если есть внешние клиенты, обдумать, как подать информацию о новой схеме — через `meta.version` или через новый endpoint `/api/content/v2`.

## 5. Подробный план работ

### Шаг 1 — Исходный анализ

1. Клонировать репозиторий и убедиться, что переключение на ветку `feature/content-v2.1-fix` прошло успешно.
2. Просмотреть файлы `ax-design/compat/ref_html_03.01_VIKTOR.md` и `ax-design/compat/ref_html_03.03_AXIOM.md` (если существует).  Отдельно записать, какие классы и атрибуты используются (`data-axv-split`, `data-tilt`, `data-title`, `data-subtitle`, `data-image`, `data-note` и пр.) — эти атрибуты потребуются для хуков.
3. Проверить, какие модули уже используют `PreviewPane` (roadmap, audit, content), чтобы оценить объём изменений.

### Шаг 2 — Разработка новых модулей и утилит

1. Создать директории `app/components/hybrid/` и `app/components/preview/` для новых хуков и модулей.
2. Реализовать `useReveal.tsx` и `useTilt.tsx`.  Пример реализации:

   ```ts
   import { useEffect } from 'react';
   export function useReveal(ref: React.RefObject<HTMLElement>) {
     useEffect(() => {
       const el = ref.current;
       if (!el) return;
       const observer = new IntersectionObserver(entries => {
         entries.forEach(entry => {
           if (entry.isIntersecting) {
             entry.target.classList.add('is-in');
           } else {
             entry.target.classList.remove('is-in');
           }
         });
       }, { threshold: 0.1 });
       observer.observe(el);
       return () => observer.disconnect();
     }, [ref]);
   }
   export function useTilt(ref: React.RefObject<HTMLElement>) {
     useEffect(() => {
       const el = ref.current;
       if (!el) return;
       const handle = (ev: PointerEvent) => {
         const rect = el.getBoundingClientRect();
         const x = (ev.clientX - rect.left) / rect.width - 0.5;
         const y = (ev.clientY - rect.top) / rect.height - 0.5;
         el.style.transform = `rotateX(${y * 5}deg) rotateY(${x * -5}deg)`;
       };
       el.addEventListener('pointermove', handle);
       el.addEventListener('pointerleave', () => el.style.transform = '');
       return () => {
         el.removeEventListener('pointermove', handle);
       };
     }, [ref]);
   }
   ```
3. Создать утилиту `prefixStyles.ts` для префиксации CSS.  Использовать `postcss` + плагин `postcss-prefix-selector`.  Настройка:

   ```ts
   import postcss from 'postcss';
   import prefixSelector from 'postcss-prefix-selector';
   export async function prefixStyles(css: string, scope: string): Promise<string> {
     const result = await postcss([
       prefixSelector({ prefix: `[data-ax-scope=\"${scope}\"]` , transform(prefix, selector) {
         // не префиксировать keyframes и root
         if (selector.startsWith('@')) return selector;
         return `${prefix} ${selector}`;
       } })
     ]).process(css, { from: undefined });
     return result.css;
   }
   }
   ```
4. Создать утилиту `resolveAssets.ts`, как описано выше, с поддержкой проверки абсолютности URI и data URI.
5. Создать `PreviewBar.tsx` и `PreviewPane.tsx` по новому API.  Перенести CSS в `ax-design/components.css`.

### Шаг 3 — Модификация контента и манифеста

1. Переместить гибридные файлы (`ref_html_03.01_VIKTOR.md`, `ref_html_03.03_AXIOM.md`) в `public/data/content/characters/CHR-VIKTOR-0301/` и `public/data/content/characters/CHR-AXIOM-0303/` соответственно.  Сохранить названия в формате `index.md` или `cover.md` + `core.md` (разделить обложку и основной текст).
2. Добавить изображения и другие ассеты в соответствующие директории.
3. Обновить `manifest.json` согласно новой схеме (см. §4.1), указать `renderMode: "hybrid"` и `assetsBase`.
4. Создать миграционный скрипт для старого контента и тестовых записей, как описано в §4.8.

### Шаг 4 — Редизайн интерфейса

1. Изменить верхнее меню: убрать иконки, добавить логотип как ссылку на `/dashboard`, внедрить underline‑эффекты.
2. Реализовать StatusLine: crumb‑чипы, версия, environment.  Написать компонент `StatusLine.tsx` или расширить существующий.
3. Обновить токены и компоненты под RED‑XS.  Проверить высоты и размеры; добавить классы для underline, glow.
4. Создать компонент `Ticker.tsx` с fade‑маской и дублями списка; добавить поддержку паузы при `hover` и выключения при `prefers-reduced-motion`.
5. Переработать страницу ContentHub: вывод категорий, фильтров, списка, превью.  Настроить responsive‑breakpoints.  Протестировать на 1920×1080, 1440×900, 1024×834, 390×844.

### Шаг 5 — Тестирование

1. **Функциональные тесты**: проверить создание, чтение и отображение записей в разных режимах; убедиться, что неправильный `renderMode` корректно обрабатывается.
2. **Юзабилити**: проверить навигацию табами/стрелками; работу `Home`/`Back`; закрепление (pin) и использование полноэкранного режима.
3. **Кросс‑браузерность**: протестировать в Chrome, Firefox, Safari; особое внимание scroll‑поведению в модальном режиме и sandbox.
4. **Доступность**: использовать Lighthouse и axe-core; устранить проблемы фокуса, контраста, aria‑меток, label/id связок.  Убедиться, что все интерактивы имеют `:focus-visible` и что анимации отключаются при `prefers-reduced-motion`.
5. **Производительность**: профилировать загрузку гибридных файлов; оптимизировать объём JS (динамическая загрузка huки, code splitting), убедиться, что префиксация CSS выполняется быстро.

### Шаг 6 — Завершение

1. Обновить документацию (README.md, Wiki) с описанием новой схемы, инструкций для авторов контента (как готовить гибридные файлы, какие data‑атрибуты поддерживаются, как подключать ассеты).
2. Провести финальный код‑ревью и рефакторинг: удалить неиспользуемый код, вынести временные решения, добавить комментарии.
3. Подготовить релиз: объединить все изменения в feature‑ветку `content-v2.1-fix`, описать в CHANGELOG.  Привязать тикеты и pull request.

## 6. Тестовый план (чек‑лист)

| №  | Сценарий                                                                      | Ожидаемый результат                                                                                                                                     |
| -- | ----------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1  | Открыть `/dashboard/content` с существующим `manifest.json` без `renderMode`. | Все записи отображаются, режим отображения по умолчанию = `plain`. Нет ошибок в консоли.                                                                |
| 2  | Выбрать запись `CHR-VIKTOR-0301` со `renderMode: hybrid`.                     | Предпросмотр отображается внизу; стили из файла ограничены областью превью; глобальное меню не изменилось; tilt/reveal работают; изображения загружены. |
| 3  | Нажать кнопку `Expand` на карточке `CHR-VIKTOR-0301`.                         | Переход на `/dashboard/content/read/CHR-VIKTOR-0301`; контент занимает большую часть экрана; в тулбаре доступны переключатели zoom и режима.            |
| 4  | Переключить renderMode на `sandbox`.                                          | Гибридный файл отображается через iframe; появляются оригинальные эффекты (если они прописаны в скриптах).                                              |
| 5  | Изменить масштаб (100 → 125 → 150%) в тулбаре.                                | Содержимое плавно увеличивается; панель не ломается; масштаб применяется только к превью.                                                               |
| 6  | Проверить работу фильтров (tag, status, lang) и поиска.                       | Список карточек обновляется, актуальная запись находится; быстрый поиск работает с debounce; выбор языка фильтрует записи.                              |
| 7  | Проверить фиксирование (pin) записи.                                          | При закреплении записи она перемещается в начало списка; иконка меняет состояние; закрепление сохраняется в LocalStorage.                               |
| 8  | Проверить status line.                                                        | Правильно отображает ENV, ONLINE, время, текущий роут, версию; на мобильных лишние чипы скрываются.                                                     |
| 9  | Проверить ticker.                                                             | Бесшовная прокрутка, пауза при наведении, статичный режим при `prefers-reduced-motion`.                                                                 |
| 10 | Проверить accessibility.                                                      | Навигация с клавиатуры (Tab/Shift+Tab), правильные ARIA‑атрибуты, высокие контрастные цвета; Lighthouse ≥ 90.                                           |

## 7. Дополнительные рекомендации

1. **Документирование pipeline**: описать процесс подготовки гибридных файлов и сборки ассетов в internal wiki.  Включить примеры шаблонов (`cover.md`, `core.md`, `<style>`, атрибуты).
2. **Генерация превью**: рассмотреть возможность автоматически генерировать «card preview» — краткое описание и обложку — на основе внутренних данных файла (например, через YAML‑фронтматтер), чтобы автору не приходилось копировать описание в `manifest.json`.
3. **Инструменты для авторов**: создать простую CLI‑утилиту (`npm run scaffold:character`) для генерации структуры папки персонажа (с template md/html, CSS, assetsBase) и автоматического обновления `manifest.json`.
4. **Мониторинг производительности**: внедрить measurement точек (например, через `performance.mark`) и выводить в консоль время загрузки и рендеринга гибридных файлов.  На основе этих данных принимать решения об оптимизации.
5. **Международный контент**: проект задуман для RU и EN.  Рекомендуется определить каталоги `public/data/content/ru/` и `public/data/content/en/` или использовать suffix в `id` (`CHR-VIKTOR-0301-ru`, `CHR-VIKTOR-0301-en`).  Панель фильтров должна позволять выбирать язык (flag icons, сокращения `RU`, `EN`).
6. **Будущие расширения**: оставить место для следующих режимов renderMode (например, `webgl` для трехмерных сцен, `video` для интерактивных роликов, `pdf` для превью документов).  Интерфейс должен быть готов принимать новые значения без глобального refactoring.

## 8. Заключение

Итерация `content‑v2.1‑fix` призвана вывести систему AXIOM из статуса демо в полноценную платформу публикации контента с гибридной разметкой.  Техническое задание, предложенное выше, описывает структурные изменения (в данных, компонентах, стилях), алгоритмы (префиксация CSS, резолвер ассетов, хуки), UX‑улучшения (RED‑XS дизайн, unified preview) и планы тестирования.  Детальная проработка обеспечит агенту понимание всех задач и снизит риски при реализации.

## 9. Дополнительные улучшения и общие рекомендации

Ниже приводятся улучшения, которые не входят напрямую в основную цель гибридных файлов, но значительно улучшат UX, безопасность и расширяемость.

### 9.1 Улучшения в модуле аутентификации

Проект использует строгий вход на основе `lib/auth/*` и `AuthGate.tsx`.  Рекомендуется:

1. **Сделать повторную авторизацию бесшовной**: токен хранить в `localStorage` с привязкой к домену и ограниченным сроком жизни; использовать `postMessage` или BroadcastChannel для синхронизации между вкладками.
2. **Использовать безопасные HTTP‑Only cookie** при переходе к серверной авторизации (если проект станет full-stack): cookie должны быть `SameSite=Lax` и `Secure`, чтобы предотвратить CSRF и XSS.  Для публичной демоверсии достаточно хранить mock‑token локально.
3. **Добавить страницу восстановления пароля** — сейчас она отсутствует; создать форму ввода email и инструкцию (в публичной версии — заглушка).
4. **Локализовать сообщения ошибок** (неправильный логин/пароль) и добавить таймаут (например, 2 секунды), чтобы избежать перебора.

### 9.2 Расширение командной панели (`command-router`)

Система поддерживает терминальные команды (help, ls, open, search, meta, log).  Предлагается:

1. **Добавить команду `content search [query]`**, которая ищет по всем материалам (включая гибридные) и возвращает список `id`, `title` и `path`.
2. **Реализовать команду `pin [id]`** для закрепления или открепления элемента через CLI.  Это позволит использовать один и тот же механизм закрепления как в UI, так и в терминале.
3. **Документировать команды в виде справки** (markdown файл в `docs/`), выводящей пример использования, доступные параметры и возможные ошибки.

### 9.3 Унификация новостной ленты (`NewsFeed`)

Новостной раздел отображает обновления (`update`, `release`, `roadmap`, `heads-up`) в виде тикера и карточек.  Рекомендуется:

1. **Добавить фильтры** по типу новостей, тегам и дате, аналогично фильтрам в ContentHub.  Это улучшит навигацию по множеству новостей.
2. **Разрешить `kind` быть массивом** — запись может одновременно относиться к обновлению и релизу.
3. **Внедрить избранное**: пользователи смогут пометить новости «star» и сохранять в localStorage; starred новости отображаются в отдельной секции.
4. **Поддержать мультиязычность**: файлы новостей должны иметь поле `lang`, аналогично контенту; фильтр по языку доступен из выпадающего списка.
5. **Улучшить `Ticker`**: показывать дату, заголовок и иконку вида новости; при клике — переходить к карточке.  На мобильных тикер автоматически переключается в горизонтальный список.

### 9.4 Общий поиск (Omni‑Search)

В проекте не хватает глобальной строки поиска.  Предлагается создать компонент `OmniSearch` со следующими особенностями:

1. **Функциональность**: поиск одновременно по контенту, новостям, лору, roadmaps и аудиту.  Использовать fuse.js или подобную библиотеку для fuzzy‑matching.
2. **UI**: открывать модальное окно по нажатию `Ctrl+K` или клику на кнопку в topbar.  Результаты отображаются списком с иконками источника (контент/новости/лore/roadmap/audit).  Навигация стрелками.
3. **Рейтинг**: учитывать частоту использования (фавориты) и совпадение со строкой поиска; сортировать результаты соответственно.
4. **Доступность**: поддержка `aria‑label`, указание количества результатов, подсветка совпадений.

### 9.5 Реактивность и производительность

1. **Prefetching**: при наведении на карточку или плитку категория предварительно загружать файл через VFS (`vfs.text()`) и кэшировать результат.  Это ускорит открытие превью.
2. **Code splitting**: динамически импортировать хуки (`useReveal`, `useTilt`, `resolveAssets`) только при необходимости.  Использовать React.lazy и Suspense.
3. **Throttling**: для scroll и resize‑обработчиков использовать `lodash/throttle` или собственную реализацию, чтобы снизить нагрузку.
4. **Профилирование**: в dev‑режиме выводить в консоль информацию о времени загрузки файла, времени префиксации CSS, времени рендера; использовать `performance.mark` и `performance.measure`.

### 9.6 Расширение лайаутов Roadmap и Audit

1. **Единый `PreviewPane`**: заменить текущие iframe‑предпросмотры roadmap и audit на новый `PreviewPane`, чтобы иметь одинаковый тулбар, zoom и поддерживать renderMode для html/markdown.
2. **Добавить фильтры** в Audit и Roadmap, аналогичные ContentHub: поиск по ключевым словам, фильтр по статусу (`open`, `done`, `in progress`), фильтр по зоне (например, `DEV`, `QA`, `LORE`).
3. **Разметка**: использовать ту же RED‑XS плотность, сетку и underline‑эффекты.  Это обеспечит единый внешний вид.
4. **Навигация по истории**: в Audit показать таймлайн изменений; использовать вертикальный список с датами и кратким описанием; при клике — открыть подробности в `PreviewPane`.

### 9.7 Валидация и линтинг контента

1. **CLI‑линтер**: написать скрипт `scripts/lint-content.js`, который проверяет: уникальность `id`, корректность `date`, наличие `file`, соответствие `category` и `subCategory` списку, присутствие обязательных полей (`title`, `summary`).
2. **Проверка ссылок**: CLI должен находить неработающие ссылки в markdown (как внутренние (`[Link](CHR-VIKTOR-0301)`) так и внешние (`https://…`)) и выводить предупреждение.  Отдельно проверять существование изображений в `assetsBase`.
3. **Локализация**: проверять, чтобы язык был одним из поддерживаемых; для каждого `id` должно быть хотя бы одно значение `lang`.
4. **Автоматическое восстановление**: если CLI замечает относительные пути, автоматически предлагать патч (обновить `assetsBase` или переместить файл).

### 9.8 Улучшения пользовательского интерфейса

1. **Drag‑to‑scroll**: добавить возможность перетаскивать список карточек горизонтально мышью (для мобильных использовать swipe‑gesture).  Это особенно полезно для списка категорий и новостей.
2. **Контекстное меню**: по правому клику на карточку открывать меню (Pin, Copy Link, Open in New Tab).  Использовать `@headlessui/react`.
3. **Copy link**: добавить в PreviewBar кнопку, копирующую прямую ссылку на файл (например, `https://axiom-demo.io/dashboard/content/read/CHR-VIKTOR-0301`).
4. **Theme switcher**: подготовить инфраструктуру для светлой темы: отдельные цветовые токены (`--ax-bg-light`, `--ax-text-light` и т.д.), хранить выбор пользователя в `localStorage`.  Реализовать в Topbar кнопку для переключения.
5. **Shortcuts**: добавить горячие клавиши: `G C` (go to content), `G R` (roadmap), `G A` (audit), `G N` (news); `Ctrl+F` — фокус на строке поиска; `Ctrl+P` — открыть omni‑search; `Shift+K` — переключить язык.

## 10. Расширение других модулей

Наконец, приведём рекомендации по развитию модулей, которые не были рассмотрены в основной задаче, но составляют важную часть инфраструктуры.

### 10.1 Библиотека gms‑render

`lib/gms-render` содержит логику для отображения заголовков и системных мета‑данных.  В публичной витрине его использование минимально (в основном статическая строка внизу).  Для полноценной интеграции рекомендуется:

1. **Реализовать динамические badges**: отображать статус (ACTIVE/DEPRECATED), источник (AI, USER, SCRIPT), зону (`03_CHARACTERS`), уровень (`LEVEL 02`) на основе `meta` контента.  Это можно сделать компонентом `GmsBadges.tsx`.
2. **Рендер блока CHANGELOG**: в гибридных файлах Виктора в начале указаны version, status и zone.  В `PreviewPane` (mode `hybrid`) предусмотреть область отображения этих полей (например, в боковой колонке).  Пользователь сможет быстро увидеть, когда файл изменялся.
3. **Интегрировать с гейм‑механикой**: внутри AXIOM существуют «миссии» и «узлы».  Для публичной витрины можно добавлять скрытые пасхалки или ссылки (e.g., «найди все красные кристаллы»).

### 10.2 Модуль telemetry

Пока `lib/telemetry/noop.ts` просто заглушка.  Для улучшения производительности и аналитики можно:

1. **Создать реальную реализацию** для публичного сайта (например, отправлять события `content_view`, `news_click`, `filter_change` в Google Analytics или PostHog).  В PRO‑версии агент может подключать собственный API.
2. **Внедрить метрики ядра**: измерять количество раз, когда пользователь использовал эффект `tilt`, сколько секунд проводят в `read`‑режиме, популярность новостей.

### 10.3 Инструменты и скрипты (`tools/`)

1. **Расширить redactor.ts**: добавить правила для удаления приватных ключей, e‑mail, номеров телефонов и любых строк, помеченных как `PRIVATE`.  Убедиться, что публичная витрина не содержит конфиденциальных данных.
2. **Обновить export.ts**: экспорт статического сайта должен поддерживать новые поля (`renderMode`, `assetsBase`), генерировать оптимизированные картинки (WebP) и создавать манифест `/manifest.webmanifest` для PWA.
3. **Сгенерировать `whitelist.json`**: описать разрешённые файлы, директории, поля для экспорта.  Это важно, чтобы случайно не добавить секреты в билд.

### 10.4 Тесты

В `tests/` уже имеются базовые тесты для VFS и новостей.  Рекомендуется:

1. **Добавить тесты для гибридных файлов**: проверять, что префиксация CSS работает, скрипты удаляются, относительные пути резолвятся.
2. **Тестировать hooks** (`useReveal`, `useTilt`) в jsdom: можно использовать библиотеку `testing-library/react` с `user-event` для имитации движения мыши и IntersectionObserver.
3. **Покрыть E2E**: использовать Playwright или Cypress.  Проверять отображение карточек, модальное окно, переключение языка, закрепление, работу omni‑search, отрисовку roadmaps и audit.  Отдельные тесты для мобильной версии (375×812) и десктопной (1920×1080).

## 11. Заключение и перспективы

В представленной итерации `content‑v2.1‑fix` мы выходим за рамки простой витрины и закладываем фундамент для масштабируемой контент‑платформы AXIOM.  Помимо исправлений существующих проблем с гибридными файлами, план охватывает расширение модулей, улучшение UX, создание общих инструментов и тестов.  Этапы расписаны так, чтобы можно было параллельно вести разработку разных задач: пока одни разработчики занимаются ядром (префиксация, renderMode), другие могут реализовывать редизайн UI или инструменты CLI.

Следующим шагом после внедрения этой итерации может стать поддержка интерактивных элементов (3D‑просмотры, графы, симуляции), разработка мобильного приложения, интеграция с AI‑моделями (генерация описаний, связанных сущностей) и открытие API для внешних разработчиков.

## 12. Roadmap / Чек-лист внедрения `content-v2.1-fix`

> Отмечайте выполненные пункты галочками. Каждая группа включает краткие критерии приёмки (AC).  
> Обозначения приоритета: **P0** — критично, **P1** — важно, **P2** — желательно.

### 12.1 Пререквизиты и подготовка
- [ ] **P0** Синхронизация ветки `feature/content-v2.1-fix` и окружений (DEV/Preview).
- [ ] **P0** Установка зависимостей (PostCSS, `postcss-prefix-selector`, `marked`, `dompurify`, `ajv`).
- [ ] **P0** Включённый strict-режим TypeScript, ESLint/Prettier профили.
- [ ] **P1** Базовый Lighthouse/axe-отчёт (замер до изменений).
- **AC:** проект собирается без ошибок; статусы ENV/ONLINE выводятся в StatusLine.

### 12.2 Схема данных и VFS (см. §4.1, §4.8)
- [x] **P0** Расширить `public/data/content/_schema/content.schema.json`: `renderMode`, `assetsBase`, `version`, `lang`, `links`. ✅ (2025-09-30, by Codex, CHG-2025-09-30-001)
- [x] **P0** Обновить `lib/vfs/*`: валидация схемы (Ajv), `strict`-режим, фильтр невалидных записей. ✅ (2025-09-30, by Codex, CHG-2025-09-30-001)
- [x] **P0** Миграционный скрипт `scripts/migrate-v2.1.js` (autofill `renderMode=plain`, `assetsBase=''`). ✅ (2025-09-30, by Codex, CHG-2025-09-30-001)
- [ ] **P1** Валидация ISO-дат, уникальности `id`, whitelists категорий/статусов.
- **AC:** любые ошибки схемы репортятся в консоль DEV, невалидные записи не ломают хаб.

### 12.3 Hybrid CSS-scoping и резолвер ассетов (см. §4.2, §4.3)
- [x] **P0** Утилита `prefixStyles.ts` (PostCSS) + переименование `@keyframes` под scope `[data-ax-scope="{id}"]`. ✅ (2025-09-30, by Codex, CHG-2025-09-30-002)
- [x] **P0** Обёртка контента `<div data-ax-scope="{id}">…</div>`. ✅ (2025-10-01, by Codex, CHG-2025-10-01-001)
- [x] **P0** Утилита `resolveAssets.ts` (переписывание `src|href` через `assetsBase`, поддержка `data:`). ✅ (2025-10-01, by Codex, CHG-2025-10-01-001)
- [ ] **P1** Обработка нескольких `<style>` в одном файле (мердж с сохранением порядка).
- **AC:** стили гибридов не протекают наружу; все изображения/ссылки работают.

### 12.4 Хуки поведения (замена `<script>`, см. §4.2 hybrid)
- [x] **P0** `useReveal` (IntersectionObserver: добавление/снятие класса `is-in`). ✅ (2025-10-01, by Codex, CHG-2025-10-01-004)
- [x] **P0** `useTilt` (pointer-наклон с reset на `pointerleave`). ✅ (2025-10-01, by Codex, CHG-2025-10-01-004)
- [x] **P1** Инициализация хуков по `data-*` атрибутам в HTML гибрида. ✅ (2025-10-01, by Codex, CHG-2025-10-01-004)
- **AC:** эффекты cover/blocks активируются без встраиваемых `<script>`.

### 12.5 PreviewPane/PreviewBar и режимы рендера (см. §4.4)
- [ ] **P0** Новый `PreviewPane` с пропсами: `item`, `dataBase`, `allowedModes`, `initialZoom`.
- [ ] **P0** `PreviewBar` (zoom 100/125/150, переключатель `plain/hybrid/sandbox`, кнопка Reload/External).
- [ ] **P0** Поддержка `sandbox` (`iframe sandbox="allow-scripts allow-same-origin"`, авто-resize через `postMessage`).
- [ ] **P1** Error-states (файл не найден, невалидный HTML/MD).
- **AC:** режимы переключаются без перезагрузки страницы; зум не ломает лэйаут.

### 12.6 Inline-expand и полноэкранный ридер (см. §4.5)
- [ ] **P1** `ContentCardExpanded` (раскрытие карточки в списке).
- [ ] **P0** Маршрут `/dashboard/content/read/:id` (full reader с `PreviewPane`).
- [ ] **P1** Mobile-policy: на узких экранах сразу открывать full reader.
- **AC:** навигация назад сохраняет фильтры и выбранный `item`.

### 12.7 Редизайн ContentHub (см. §4.6)
- [ ] **P1** Обновить `ContentCategoryTiles` (ARIA `tablist/tab`, active-state, counts).
- [ ] **P1** Компактные фильтры (`ax-input`, `ax-chip`, debounce для поиска).
- [ ] **P1** Список: pin-иконка, `line-clamp`, tooltip summary, автор/аватар (если есть).
- [ ] **P1** Sticky `PreviewPane` ~72vh, автоскролл к превью при выборе.
- **AC:** UX единообразен и читаем на 1920/1440/1024/390 ширинах.

### 12.8 Токены и глобальные эффекты (см. §4.7)
- [ ] **P1** RED-XS плотность (`--ax-scale: 0.9`, пересчёт `--btn-h/--chip-h/--input-h`).
- [ ] **P1** `.ax-link-underline` с анимацией `::after` (меню/табы/линки).
- [ ] **P1** StatusLine (crumbs: MODE/SECTION/ENV/версия/время).
- [ ] **P2** Обновлённый `Ticker` (fade-mask, pause-on-hover, reduced-motion).
- **AC:** визуально единый стиль, контраст и фокус соответствуют a11y.

### 12.9 Контент и манифест
- [ ] **P0** Разложить `CHR-VIKTOR-0301` и `CHR-AXIOM-0303` по каталогу `public/data/content/characters/<ID>/` (+ ассеты).
- [ ] **P0** Обновить `manifest.json`: `renderMode: "hybrid"`, `assetsBase`, `lang`, `version`.
- [ ] **P1** Проверка относительных ссылок/картинок (CLI-линтер).
- **AC:** гибриды открываются; обложки/картинки видны в preview и reader.

### 12.10 Тестирование (см. §6)
- [ ] **P0** Юнит-тесты: префиксация CSS, `resolveAssets`, рендер `plain/hybrid/sandbox`.
- [ ] **P1** a11y-проверки (axe), Lighthouse ≥ 90.
- [ ] **P1** E2E (Playwright/Cypress): выбор карточки, фильтры, pin, reader, sandbox.
- **AC:** зелёные тесты в CI; отчёты приложены к PR.

### 12.11 Документация и миграции (см. §4.8)
- [ ] **P1** Обновить README/Wiki: схема, поля, примеры `data-*` атрибутов, шаблоны cover/core.
- [ ] **P1** Описать CLI-скрипты (`migrate`, `lint-content`, `scaffold:character`).
- [ ] **P2** CHANGELOG с перечислением новых полей и breaking changes.
- **AC:** авторы могут создать гибрид «по инструкции» без участия разработчика.

### 12.12 Релиз и пост-релиз
- [ ] **P0** Code review, squash-merge в `feature/content-v2.1-fix`.
- [ ] **P0** Smoke-тест DEV → Preview → Prod.
- [ ] **P1** Телеметрия: события `content_view`, `reader_open`, `mode_switch`.
- [ ] **P2** Пост-релизный мониторинг (ошибки, производительность, a11y регрессии).
- **AC:** релиз стабилен, критических регрессий нет, метрики собираются.

отлично. ниже — готовый блок для вставки в конец рабочего файла как `## 13`. он включает правила ведения журнала, шаблоны записей, метки статусов и примеры. агенту достаточно копировать нужный шаблон и заполнять.



## 13. CHANGELOG / LIVE LOG ДЛЯ АГЕНТА

> Назначение: единая «живая» история работ по итерации `content-v2.1-fix`.  
> В этот раздел агент **добавляет новые записи** (сверху вниз), а чек-пункты в §12 — **отмечает галочками**.  
> Таймзона для времени: **Europe/Berlin**. Формат даты: `YYYY-MM-DD HH:mm`.

### 13.1 Что фиксировать в журнале
- Каждое **существенное действие**: коммит, PR, правка манифеста/схемы, доработка компонента, миграция, правка токенов, тесты, документация.
- **Ссылки на артефакты**: коммит/PR/issue, путь к файлам.
- **Связь с чек-листом**: указывай ID пунктов из §12, которые закрываешь (например, `12.3-P0`, `12.5-P0`).
- **Статус**: `OPEN` → `IN_PROGRESS` → `DONE` или `BLOCKED` / `REVERTED`.
- **Результат проверки по AC** (Acceptance Criteria) из §12.
- **Риски/заметки** (если есть), чтобы следующий исполнитель видел контекст.

### 13.2 Как отмечать галочки в §12
1) **Выполнил пункт** — меняешь `- [ ]` на `- [x]` **в §12** и в конце строки добавляешь:  
   `✅ (YYYY-MM-DD, by AgentName, CHG-ID)`  
2) **В лог §13** добавляешь запись с тем же `CHG-ID`, где перечисляешь закрытые пункты и ссылку на коммит/PR.

> Пример отметки в §12:  
> `- [x] P0 Новый PreviewPane ...  ✅ (2025-09-30, by AXIOM Codex, CHG-2025-09-30-002)`

### 13.3 Правила оформления записей
- **Одна запись — один логический блок работ** (может включать несколько файлов/коммитов, если это одна задача).
- **Минимум**: заголовок, список изменений (bullets), ссылки, проверка AC, статус.
- Пиши кратко и предметно; без «воды». Если нужно много контекста — вынеси в «Notes».

### 13.4 Схема ID и метки
- **ID записи**: `CHG-YYYY-MM-DD-XXX` (сквозная нумерация в пределах дня).
- **Тип изменения** (label в квадратных скобках, можно несколько):  
  `[FEAT]` новая фича · `[FIX]` исправление · `[REFACTOR]` рефакторинг · `[DOC]` документация · `[TEST]` тесты · `[CHORE]` прочие · `[BREAKING]` несовместимые изменения · `[REVERT]` откат.
- **Статусы**: `OPEN`, `IN_PROGRESS`, `BLOCKED`, `DONE`, `REVERTED`.

### 13.5 Шаблон записи (скопируй и заполни)

#### Короткий (микро-правка)
```md
### CHG-YYYY-MM-DD-XXX — [FIX] Короткое название (СТАТУС)

**Scope:** files/paths
**Links:** commit … | PR … | Issue …
**Closed §12:** 12.x-Px
**Changes:**
- …
**AC Check:** пройдено/не пройдено (кратко по пунктам)
**Notes:** …
````

#### Полный (фича/компонент/модуль)

```md
### CHG-YYYY-MM-DD-XXX — [FEAT] Название блока работ (СТАТУС)

**Related:** 12.x-Px, 12.y-Py
**Artifacts:**
- Commit(s): <hash/links>
- PR: <link> (labels: feat, content-v2.1-fix)
- Files: 
  - app/components/PreviewPane.tsx
  - app/components/preview/PreviewBar.tsx
  - lib/vfs/index.ts
  - public/data/content/_schema/content.schema.json
**Summary:**
- Кратко, что реализовано и зачем (1–3 пункта).

**Changes:**
- Технические шаги (по делу):
  - …
  - …

**AC Check (из §12):**
- [x] AC-1: «режимы переключаются без перезагрузки»
- [x] AC-2: «зум не ломает лэйаут»
- [ ] AC-3: «ошибки обработаны» (останется в следующем CHG)

**Risks / Follow-ups:**
- Риск/блокер: …
- Следующие шаги: CHG-YYYY-MM-DD-NNN (заведи запись)

**Result:** DONE / PARTIAL
```

### 13.6 Рекомендованный шаблон коммита

```
type(scope): кратко, что сделано

why:
- мотивация/контекст (1–2 пункта)

what:
- основные изменения по файлам

ac:
- ссылка на AC из §12

refs:
- CHG-YYYY-MM-DD-XXX, §12.5-P0
```

> `type` = feat | fix | refactor | test | docs | chore | perf | build | ci | revert

### 13.7 Критерии приёмки (напоминание)

* **Сначала** сверяйся с AC у соответствующего пункта в §12.
* Если AC не закрывается полностью — ставь `Result: PARTIAL` и заводи **следующую** запись CHG с остатком.

### 13.8 Примеры готовых записей

```md
### CHG-2025-09-30-001 — [FIX] Резолвер ассетов для гибридов (DONE)
**Related:** 12.3-P0, 12.9-P0
**Artifacts:** commit 1a2b3c4 (resolveAssets.ts), PR #128
**Changes:**
- Добавлен `resolveAssets()` для переписывания относительных `src|href` в `assetsBase`.
- Подключён резолвер в `PreviewPane` для режимов `plain`/`hybrid`.
**AC Check:**
- [x] Картинки в `CHR-VIKTOR-0301` отображаются в preview и reader.
- [x] Нет 404 на относительных путях.
**Result:** DONE
```

```md
### CHG-2025-09-30-002 — [FEAT] Новый PreviewPane + PreviewBar (IN_PROGRESS)
**Related:** 12.5-P0
**Artifacts:** branch feature/previewpane-v2
**Changes:**
- Черновой `PreviewPane` с `allowedModes` и `initialZoom`.
- `PreviewBar`: зум-контролы, переключатель `plain/hybrid/sandbox`.
**AC Check:**
- [x] Переключение режимов без перезагрузки.
- [ ] Обработка ошибок (оставлено на CHG-2025-10-01-001).
**Result:** PARTIAL
```

```md
### CHG-2025-10-01-003 — [REVERT] Откат префиксации keyframes (REVERTED)
**Related:** 12.3-P0
**Artifacts:** revert 7d8e9f0, PR #131
**Changes:**
- Вернул оригинальные имена `@keyframes`, так как ломались CSS-анимации в `sandbox`.
**Notes:** Будет повторно внедрено после фикса в `prefixStyles` (ignore keyframes in sandbox).
**Result:** DONE
```

### 13.9 Ежедневный дайджест (опционально)

В конце дня добавляй короткую сводку:

```md
#### DIGEST 2025-10-01
- Закрыто: 12.3-P0, 12.9-P0
- Открыто: 12.5-P0 (осталось errors), 12.7-P1
- Риски: задержка по a11y-проверкам
- Следующие CHG: 2025-10-02-001 (errors), 2025-10-02-002 (a11y)
```

### 13.10 Мини-памятка агенту

* Всегда **сначала** сверяйся с §12 и **привязывай** CHG к конкретным пунктам.
* Любая правка, что влияет на поведение/схему/дизайн — **CHG-запись обязательна**.
* Если правка «технический шум» (переименования, форматирование), метка `[CHORE]`.
* Не «переписывай историю» — новые факты добавляй новой записью.

### 13.LOG — Журнал изменений (append-new-on-top)

> Это единственная зона для живых записей. Новые — **вставлять прямо под маркер LOG:START** (самая свежая выше).  
> Нельзя трогать заголовок раздела и маркеры — на них завязан автоапдейт.

<!-- LOG:START (do not remove) -->
#### CHG-2025-10-01-004 — [FEAT] Interaction hooks rollout (DONE)
**Related:** §12.4-P0
**Artifacts:** lib/content-hooks/*; components/PreviewPane.tsx; public/data/content/characters/03.01_VIKTOR.md; styles/app.css; tests/contentHooks.spec.ts
**Changes:**
- Реализованы `attachReveal` и `attachTilt`, авто-инициализация по `data-*`, unit-тесты сценариев.
- Обновлён `PreviewPane`: подключение хуков для plain/hybrid, очистка inline-скриптов.
- Обновлён контент `03.01_VIKTOR`: `data-reveal`/`data-tilt` вместо встроенного JS.
- Обновлены стили тулбара/контента под новые состояния.
**AC Check:**
- [x] `useReveal` добавляет/снимает `is-in` через IntersectionObserver и уважает отключение анимаций.
- [x] `useTilt` даёт интерактивный эффект с reset и fallback при reduced-motion.
- [x] Инициализация происходит через `data-*` без inline-скриптов, ошибки не ломают верстку.
- [x] Документация и чек-листы обновлены, деградация не влияет на plain/hybrid сценарии.
**Result:** DONE

#### CHG-2025-10-01-005 — [PLAN] Full reader route scaffolding (OPEN)
**Related:** §12.6-P0
**Artifacts:** TBD
**Changes (plan):**
- Проанализировать текущие маршруты ContentHub и требования к `/dashboard/content/read/:id`.
- Спроектировать архитектуру: layout, загрузчики данных, взаимодействие с PreviewPane и сохранение фильтров.
- Подготовить роут, навигацию и тестовое покрытие (desktop/mobile, возврат назад).
- Обновить §4/§12, зафиксировать артефакты после завершения.
**AC Check:**
- [ ] Маршрут `/dashboard/content/read/:id` отображает PreviewPane в full-view без потери фильтров.
- [ ] Навигация обратно сохраняет состояние выбора/фильтров.
- [ ] Поддержаны desktop/mobile сценарии (mobile сразу открывает full reader).
- [ ] AC из §12.6 задокументированы и покрыты smoke-тестом.
**Result:** OPEN


#### CHG-2025-10-01-002 — [FEAT] PreviewBar mode toggles (DONE)
**Related:** §12.5-P0
**Artifacts:** components/PreviewPane.tsx; components/preview/PreviewBar.tsx; styles/app.css
**Changes:**
- Обновлён `PreviewPane`: добавлены пропсы `allowedModes`/`initialZoom`, управление zoom/mode, sandbox через `srcdoc` с auto-resize и reload.
- Добавлен `PreviewBar` с переключением `plain/hybrid/sandbox`, контролами зума, кнопкой reload и поддержкой внешних ссылок.
- Обновлены стили превью для активных состояний кнопок/чипов и новых контролов масштабирования.
**AC Check:**
- [x] Параметры `allowedModes` и `initialZoom` работают в PreviewPane.
- [x] PreviewBar переключает режимы и зум без перезагрузки.
- [x] Режим `sandbox` поддерживает reload и auto-resize.
- [x] Ошибки/empty-состояния покрыты интерфейсом.
**Result:** DONE

#### CHG-2025-10-01-001 — \[FEAT] Hybrid preview asset scoping (DONE)
**Related:** §12.3-P0
**Artifacts:** components/PreviewPane.tsx; lib/hybrid/prefixStyles.ts; lib/hybrid/resolveAssets.ts
**Changes:**
- Подключён `prefixStyles` в PreviewPane и добавлена обёртка `data-ax-scope` для hybrid-режима.
- Реализован `resolveAssets` с обработкой относительных путей и встроенный вызов в plain/hybrid.
- Переписан рендер превью: режимы, ошибки, iframe/sandbox и безопасная подстановка HTML.
**AC Check:**
- [x] Стили гибридов изолированы внутри превью и не протекают на остальной UI.
- [x] Относительные `src|href` в plain/hybrid корректно резолвятся через `assetsBase`.
**Result:** DONE

#### CHG-2025-09-30-002 — \[FEAT] PrefixStyles utility & preview sanitization (DONE)
**Related:** §12.3-P0
**Artifacts:** branch feature/content-v2.1-fix/hybrid-css; files: components/PreviewPane.tsx, lib/hybrid/prefixStyles.ts, lib/hybrid/postcss-prefix-selector.d.ts
**Changes:**
- Добавлен типобезопасный конфиг DOMPurify в PreviewPane.
- Реализована утилита `prefixStyles` с перестройкой `@keyframes` и префиксацией селекторов.
- Добавлена декларация типов для `postcss-prefix-selector`.
**AC Check:**
- [x] Префиксер добавляет scope `[data-ax-scope="{id}"]` для всех селекторов вне at-rule.
- [x] Имена `@keyframes` и ссылки в `animation*` получают уникальный scoped-префикс.
**Result:** DONE

<!-- ВСТАВЛЯЙ НОВЫЕ ЗАПИСИ СРАЗУ ПОСЛЕ ЭТОЙ СТРОКИ -->
#### CHG-2025-09-30-001 — \[FEAT] Schema/VFS v2.1 baseline (DONE)
**Related:** §12.2-P0
**Artifacts:** lib/vfs/index.ts; public/data/content/_schema/content.schema.json; scripts/migrate-v2.1.js; tests/vfs.spec.ts; tests: `npx vitest run tests/vfs.spec.ts`
**Changes:**
- Расширена content schema (renderMode, assetsBase, version, lang, links) и ужесточены паттерны.
- Обновлён VFS: строгий Ajv, фильтрация невалидных записей, дефолты renderMode/assetsBase, поддержка режима strict.
- Добавлен скрипт `scripts/migrate-v2.1.js` и переработаны unit-тесты VFS под новые правила.
**AC Check:**
- [x] AC-1: ошибки схемы выводятся в консоль DEV (console.error) и в strict-режиме приводят к throw.
- [x] AC-2: невалидные записи не ломают ContentHub (невалид фильтруется, strict бросает ошибку).
**Result:** DONE



#### CHG-YYYY-MM-DD-XXX — \[TYPE] Короткий заголовок (STATUS)
**Related:** §12.x-Px, §12.y-Py  
**Artifacts:** commit <hash>, PR <link>, files: …  
**Changes:**
- …
**AC Check:**
- [x] …
- [ ] …
**Result:** DONE / PARTIAL / BLOCKED  
**Notes:** …

<!-- LOG:END (do not remove) -->

